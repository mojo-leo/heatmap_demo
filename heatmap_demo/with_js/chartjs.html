<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chart.js heatmap (Top-N)</title>
  <style>
    body{font-family:system-ui,sans-serif;margin:16px}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #wrap{margin-top:10px;border:1px solid #ddd;padding:8px}
    canvas{max-width:100%}
  </style>

  <!-- Chart.js + Matrix plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2/dist/pako.min.js"></script>
</head>
<body>
  <h2>Exporter â†’ Importer heatmap (Top-N by total quantity)</h2>
  <div class="controls">
    <label>Top N</label>
    <input id="n" type="range" min="2" max="10" step="1" value="10" />
    <span id="nv">10</span>
  </div>

  <div id="wrap">
    <canvas id="c" width="950" height="950"></canvas>
  </div>

  <script>
    // Decompress base64-encoded gzip data
    function decompressData(base64Data) {
      const binaryString = atob(base64Data);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      const decompressed = pako.inflate(bytes, { to: 'string' });
      return JSON.parse(decompressed);
    }
    
    // Template variable: base64-encoded gzip-compressed JSON
    const RECORDS = decompressData(__EMBEDDED_DATA__);

    function countryOrder(records){
      const totals = new Map();
      for(const r of records){
        const e = r.exporter_name, i = r.importer_name, q = +r.quantity;
        if(!e || !i || !Number.isFinite(q)) continue;
        totals.set(e, (totals.get(e)||0) + q);
        totals.set(i, (totals.get(i)||0) + q);
      }
      return Array.from(totals.entries()).sort((a,b)=>b[1]-a[1]).map(d=>d[0]);
    }

    function buildMatrix(records, countries){
      const idx = new Map(countries.map((c,i)=>[c,i]));
      const n = countries.length;
      const z = Array.from({length:n}, ()=>Array(n).fill(0));
      for(const r of records){
        const e = r.exporter_name, i = r.importer_name, q = +r.quantity;
        if(!idx.has(e) || !idx.has(i) || !Number.isFinite(q)) continue;
        z[idx.get(i)][idx.get(e)] += q;
      }
      return z;
    }

    function fmt(x){
      return Number(x).toLocaleString(undefined,{maximumFractionDigits:3});
    }

    // Tiny viridis-ish gradient (good enough for demo)
    function lerp(a,b,t){ return a + (b-a)*t; }
    function hexToRgb(h){
      const x = h.replace("#","");
      return [parseInt(x.slice(0,2),16), parseInt(x.slice(2,4),16), parseInt(x.slice(4,6),16)];
    }
    function rgbToHex(r,g,b){
      const f = (v)=>v.toString(16).padStart(2,"0");
      return "#"+f(r)+f(g)+f(b);
    }
    // 3-stop gradient
    const stops = ["#440154","#21918c","#fde725"].map(hexToRgb);
    function colorFor(t){
      t = Math.max(0, Math.min(1, t));
      const a = t < 0.5 ? stops[0] : stops[1];
      const b = t < 0.5 ? stops[1] : stops[2];
      const u = t < 0.5 ? (t/0.5) : ((t-0.5)/0.5);
      return rgbToHex(
        Math.round(lerp(a[0], b[0], u)),
        Math.round(lerp(a[1], b[1], u)),
        Math.round(lerp(a[2], b[2], u)),
      );
    }

    const countries = countryOrder(RECORDS);
    const Z = buildMatrix(RECORDS, countries);

    const slider = document.getElementById("n");
    const label = document.getElementById("nv");

    slider.min = 2;
    slider.max = Math.max(2, countries.length);
    slider.value = String(Math.min(10, countries.length));

    const ctx = document.getElementById("c").getContext("2d");
    let chart = null;

    function buildData(n){
      const names = countries.slice(0,n);
      const pts = [];
      let maxv = 0;
      for(let y=0;y<n;y++){
        for(let x=0;x<n;x++){
          const v = Z[y][x];
          if (v > maxv) maxv = v;
          pts.push({x: names[x], y: names[y], v});
        }
      }
      const denom = Math.sqrt(maxv || 1);
      // Precompute fill color per point
      for (const p of pts){
        const t = Math.sqrt(p.v || 0) / denom;
        p.c = colorFor(t);
      }
      return { names, pts, maxv };
    }

    function render(){
      const n = parseInt(slider.value, 10);
      label.textContent = String(n);

      const { names, pts } = buildData(n);

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "matrix",
        data: {
          datasets: [{
            data: pts,
            backgroundColor: (c) => c.raw.c,
            borderWidth: 0,
            width: (c) => {
              const a = c.chart.chartArea;
              return a ? (a.width / n) : 10;
            },
            height: (c) => {
              const a = c.chart.chartArea;
              return a ? (a.height / n) : 10;
            },
          }]
        },
        options: {
          animation: false,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: "category",
              labels: names,
              ticks: { autoSkip: false, maxRotation: 45, minRotation: 45 },
              title: { display: true, text: "Exporter country" },
              grid: { display: false },
            },
            y: {
              type: "category",
              labels: names,
              reverse: true,
              ticks: { autoSkip: false },
              title: { display: true, text: "Importer country" },
              grid: { display: false },
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: () => "",
                label: (item) => {
                  const x = item.raw.x;
                  const y = item.raw.y;
                  const v = item.raw.v;
                  return [`Exporter: ${x}`, `Importer: ${y}`, `Quantity: ${fmt(v)}`];
                }
              }
            }
          }
        }
      });
    }

    slider.addEventListener("input", render);
    render();
  </script>
</body>
</html>