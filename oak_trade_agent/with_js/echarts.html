<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ECharts heatmap (Top-N)</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/pako@2/dist/pako.min.js"></script>
  <style>
    body{font-family:system-ui,sans-serif;margin:16px}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    #chart{margin-top:10px;width:100%;height:900px;border:1px solid #ddd}
  </style>
</head>
<body>
  <h2>Exporter â†’ Importer heatmap (Top-N by total quantity)</h2>
  <div class="controls">
    <label>Top N</label>
    <input id="n" type="range" min="2" max="10" step="1" value="10" />
    <span id="nv">10</span>
  </div>
  <div id="chart"></div>

  <script>
    // Decompress base64-encoded gzip data
    function decompressData(base64Data) {
      const binaryString = atob(base64Data);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      const decompressed = pako.inflate(bytes, { to: 'string' });
      return JSON.parse(decompressed);
    }
    
    // Template variable: base64-encoded gzip-compressed JSON
    const RECORDS = decompressData(__EMBEDDED_DATA__);

    function countryOrder(records){
      const totals = new Map();
      for(const r of records){
        const e = r.exporter_name, i = r.importer_name, q = +r.quantity;
        if(!e || !i || !Number.isFinite(q)) continue;
        totals.set(e, (totals.get(e)||0) + q);
        totals.set(i, (totals.get(i)||0) + q);
      }
      return Array.from(totals.entries()).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
    }

    function buildMatrix(records, countries){
      const idx = new Map(countries.map((c,i)=>[c,i]));
      const n = countries.length;
      const z = Array.from({length:n}, ()=>Array(n).fill(0));
      for(const r of records){
        const e = r.exporter_name, i = r.importer_name, q = +r.quantity;
        if(!idx.has(e) || !idx.has(i) || !Number.isFinite(q)) continue;
        z[idx.get(i)][idx.get(e)] += q;
      }
      return z;
    }

    const countries = countryOrder(RECORDS);
    const Z = buildMatrix(RECORDS, countries);

    const chart = echarts.init(document.getElementById("chart"));
    const slider = document.getElementById("n");
    const label = document.getElementById("nv");

    slider.min = 2;
    slider.max = Math.max(2, countries.length);
    slider.value = String(Math.min(10, countries.length));

    function optionFor(n){
      const names = countries.slice(0, n);
      const data = [];
      for(let y=0;y<n;y++) for(let x=0;x<n;x++) data.push([x, y, Z[y][x]]);
      let maxv = 0; for(const d of data) if(d[2] > maxv) maxv = d[2];

      return {
        animation: false,
        grid: {left: 140, top: 120, right: 40, bottom: 80},
        tooltip: {
          position: "top",
          formatter: (p) => {
            const x = names[p.data[0]], y = names[p.data[1]], v = p.data[2];
            return `Exporter: ${x}<br/>Importer: ${y}<br/>Quantity: ${Number(v).toLocaleString(undefined,{maximumFractionDigits:3})}`;
          }
        },
        xAxis: {type: "category", name: "Exporter country", data: names, axisLabel: {rotate: 45}},
        yAxis: {type: "category", name: "Importer country", data: names},
        visualMap: {min: 0, max: maxv || 1, right: 10, top: "middle"},
        series: [{type: "heatmap", data}]
      };
    }

    function render(){
      const n = parseInt(slider.value, 10);
      label.textContent = String(n);
      chart.setOption(optionFor(n), true);
    }

    window.addEventListener("resize", () => chart.resize());
    slider.addEventListener("input", render);
    render();
  </script>
</body>
</html>